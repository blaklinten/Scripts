#!/bin/bash

# A script that shuffles all songs in a directory

trap "pkill mpv; pkill shuffle; exit;" SIGINT 
CONTINUE=1
DIR_TO_PLAY="$1"

stop_looping()
{
  unset CONTINUE
  if [ -n "$CURRENT_MPV_LOOP" ];then
    echo Killing PID: $CURRENT_MPV_LOOP
    kill "$CURRENT_MPV_LOOP"
  else
    echo Current bg PID id empty...
  fi
}

stop_playing()
{
  pkill mpv
}

play_random_song()
{
  SONG="$(find "$DIR_TO_PLAY" -type f | shuf -n1)"
  echo "Playing random $SONG"
  mpv "$SONG" 2&> /dev/null
}

random_loop()
{
  # Allow for more looping
  CONTINUE=1
  while [ -n "$CONTINUE" ]; do
    play_random_song
  done &
}

choose_song()
{
  SONG="$(find "$DIR_TO_PLAY" -type f | dmenu -i -p "Choose a song to play:" -l 30)"
  #Stop looping
  stop_looping
  #Stop playing
  stop_playing
  echo "Playing chosen $SONG"
  {
    mpv "$SONG" 2&> /dev/null
    random_loop
    echo Playing random song... PID: $!
    CURRENT_MPV_LOOP="$!"
  } &
}

echo "Choose a song to play (c) or play a random one (p)."
while true; do
  echo "Script PID id $$"
  read -r -n1 -s
  case "$REPLY" in
    "c")
      choose_song
      ;;
    "p")
      random_loop
      ;;
    "n")
      pkill mpv
      ;;
    "q")
      unset CONTINUE
      stop_looping
      exit
      ;;
    *)
      continue
      ;;
  esac
done
